	<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>THÁM TỬ Y SÊ BA - TẬP 1</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Be+Vietnam+Pro:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --comic-blue: #00d2ff; --comic-red: #ff3e3e; --comic-yellow: #ffee00; --paper: #ffffff; }
        body { background: #1a1a1a; font-family: 'Be Vietnam Pro', sans-serif; margin: 0; padding: 10px; overflow-x: hidden; transition: background 0.5s ease; }
        
        .page-transition { animation: slideIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; }
        @keyframes slideIn { 0% { opacity: 0; transform: translateX(50px); } 100% { opacity: 1; transform: translateX(0); } }

        .shake-screen { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-10px); } 40%, 80% { transform: translateX(10px); } }

        .main-header { text-align: center; margin: 20px auto; max-width: 900px; background: var(--comic-red); padding: 15px; border: 6px solid #000; transform: rotate(-1deg); box-shadow: 10px 10px 0 var(--comic-yellow); transition: transform 0.2s ease; }
        .main-header:hover { transform: rotate(0deg) scale(1.01); }

        .main-title { font-family: 'Montserrat'; font-size: 2.5em; margin: 0; color: #fff; -webkit-text-stroke: 2px #000; text-transform: uppercase; line-height: 1; }
        .main-subtitle { font-family: 'Be Vietnam Pro'; font-size: 1em; font-weight: 800; color: #000; text-transform: uppercase; margin-top: 5px; background: #fff; padding: 2px 10px; display: inline-block; border: 2px solid #000; }
        .case-file { background: var(--paper); max-width: 850px; margin: 0 auto; padding: 25px; border: 5px solid #000; box-shadow: 15px 15px 0 #000; position: relative; }
        .comic-panel { border: 4px solid #000; padding: 25px; background: #fff; position: relative; }
        .chapter-badge { position: absolute; top: -15px; left: 20px; background: #000; color: var(--comic-yellow); padding: 5px 20px; font-weight: 900; transform: skewX(-15deg); border: 2px solid var(--comic-red); z-index: 10; }
        
        /* Chỉnh lại font-weight ở đây để không bị in đậm toàn bộ */
        .story-text-block { font-size: 1.1em; line-height: 1.7; font-weight: 400; text-align: justify; margin: 15px 0; padding: 15px; border: 3px solid #000; background: #f9f9f9; }
        
        /* Chỉnh lại bubble chat không bị in đậm */
        .bubble { padding: 15px 20px; border: 4px solid #000; border-radius: 15px; max-width: 85%; font-weight: 500; box-shadow: 5px 5px 0 #000; margin-bottom: 20px; position: relative; transition: transform 0.2s; }
        .bubble:hover { transform: translateY(-2px); }

        .chat-left .bubble { background: #e3f2fd; align-self: flex-start; }
        .chat-right .bubble { background: #fffde7; align-self: flex-end; }
        .char-label-container { margin-bottom: -5px; display: flex; z-index: 2; position: relative; }
        .chat-left .char-label-container { justify-content: flex-start; padding-left: 10px; }
        .chat-right .char-label-container { justify-content: flex-end; padding-right: 10px; }
        .char-full-name { font-family: 'Montserrat', sans-serif; font-size: 1em; font-weight: 900; color: #fff; background: #000; padding: 4px 12px; border: 3px solid #000; display: inline-block; text-transform: uppercase; transform: skewX(-10deg); box-shadow: 3px 3px 0 var(--comic-yellow); }
        .chat-left .char-full-name { background: var(--comic-red); }
        .chat-right .char-full-name { background: var(--comic-blue); }
        
        .nav-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 15px; border-top: 5px solid #000; min-height: 60px; }
        .comic-btn { background: #000; color: #fff; border: 3px solid #000; padding: 10px 25px; font-family: 'Montserrat'; font-weight: 900; cursor: pointer; text-transform: uppercase; box-shadow: 4px 4px 0 var(--comic-red); transition: 0.1s; }
        .comic-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 var(--comic-red); }
        .comic-btn:disabled { visibility: hidden; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .quiz-card { background: #fff; border: 6px solid #000; width: 95%; max-width: 550px; padding: 25px; box-shadow: 15px 15px 0 var(--comic-blue); position: relative; }
        .streak-container { background: #000; color: #fff; padding: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .streak-bg { flex-grow: 1; height: 10px; background: #444; margin: 0 15px; border: 1px solid #fff; }
        .streak-fill { height: 100%; background: var(--comic-yellow); transition: width 0.3s; width: 0%; }
        .quiz-instruction { font-family: 'Montserrat'; font-weight: 900; text-transform: uppercase; font-size: 0.9em; text-align: center; background: var(--comic-red); color: white; padding: 5px; margin-bottom: 10px; border: 3px solid #000; }
        
        .quiz-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 3px solid #000; }
        .quiz-table th, .quiz-table td { border: 2px solid #000; padding: 10px; font-weight: 800; text-align: center; }
        
        .matching-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .match-col { display: flex; flex-direction: column; gap: 10px; }
        .match-item { border: 3px solid #000; padding: 10px; font-weight: 800; background: #fff; text-align: center; font-size: 0.9em; position: relative; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        
        .match-left-item { background: #f0f0f0; transition: background 0.2s; }
        .match-right-item { cursor: grab; background: var(--comic-yellow); }
        .match-right-item:active { cursor: grabbing; }

        .match-left-item.matched { background: #4caf50; color: white; border-style: dashed; cursor: pointer; }

        .opt-item { border: 4px solid #000; margin: 10px 0; padding: 15px; font-weight: 900; cursor: pointer; background: #fff; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden; }
        .opt-item:hover { transform: scale(1.02); background: #f0f0f0; box-shadow: 6px 6px 0 #000; }
        .opt-item.selected { background: var(--comic-yellow); transform: scale(1.02); box-shadow: 6px 6px 0 #000; }
        .opt-item.correct { background: #4caf50 !important; color: white; border-color: #000; box-shadow: 6px 6px 0 #000; }
        .opt-item.wrong { background: var(--comic-red) !important; color: white; border-color: #000; box-shadow: 6px 6px 0 #000; }
        
        #final-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; text-align: center; }
        .result-box { background: #fff; border: 8px solid #000; padding: 40px; max-width: 550px; box-shadow: 20px 20px 0 var(--comic-yellow); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<header class="main-header">
    <h1 id="header-title" class="main-title">THÁM TỬ Y SÊ BA</h1>
    <div id="header-subtitle" class="main-subtitle">Tập 1: Bã mía tử thần</div>
</header>

<div id="game-container" class="case-file">
    <div id="content-render"></div>
    <div class="nav-footer">
        <button id="btn-prev" class="comic-btn" onclick="prev()">LÙI</button>
        <div id="nav-dots" style="display:flex; gap:8px;"></div>
        <button id="btn-next" class="comic-btn" onclick="handleNext()">TIẾP</button>
    </div>
</div>

<div id="final-overlay" onclick="closeResult()">
    <div class="result-box" id="result-content" onclick="event.stopPropagation()"></div>
</div>

<div id="quiz-modal" class="modal">
    <div class="quiz-card" id="quiz-box">
        <div class="close-quiz" style="position:absolute; top:-15px; right:-15px; background:red; border:3px solid #000; color:white; width:30px; height:30px; line-height:30px; text-align:center; cursor:pointer; font-weight:900;" onclick="closeQuiz()">X</div>
        <div class="quiz-instruction" id="q-instr">Trả lời câu hỏi để qua trang tiếp theo</div>
        <div class="streak-container">
            <span>STREAK:</span>
            <div class="streak-bg"><div id="streak-bar" class="streak-fill"></div></div>
            <span id="streak-val">0/5</span>
        </div>
        <p id="q-desc" style="font-weight:800; margin-bottom:15px;"></p>
        <div id="q-container"></div>
        <div id="q-msg" style="color:var(--comic-red); font-weight:900; text-align:center; margin-top:10px; min-height:20px;"></div>
        <button class="comic-btn" style="width:100%; margin-top:15px;" onclick="checkQuiz()">XÁC NHẬN ĐÁP ÁN</button>
    </div>
</div>

<script>
const CONFIG = { title: "THÁM TỬ Y SÊ BA", subtitle: "Tập 1: Bã mía tử thần", requiredStreak: 5 };

const story = [
    { 
        type: "intro", t: "GIỚI THIỆU", img: "", 
        flow: [
            { type: "text", content: `<div style="background:var(--comic-yellow); padding:15px; border:3px solid #000; margin-bottom:20px; text-align:left; font-weight:500;">
            <b>BỐI CẢNH:</b></br>Chào mừng bạn đến với Ocean-City, thành phố của những ánh đèn neon rực rỡ nhưng ẩn khuất bóng ma của tội phạm công nghệ cao. Tại đây, ranh giới giữa thực tại và ảo ảnh mỏng manh như một sợi cáp quang; nơi sự thật luôn bị bủa vây và che giấu sau những lớp tường lửa kiên cố nhất."</br></br>
            <b>HƯỚNG DẪN:</b></br>1. Quan sát: Theo chân thám tử Y Sê Ba thu thập manh mối.</br>2. Giải đố: Trả lời đúng câu hỏi mới có thể qua trang.</br>3. Phá án: Chọn đúng hung thủ ở trang cuối để đòi lại công lý.</div>` }
        ],
        chars: [
            {n: "THÁM TỬ Y Sê Ba", d: "Thiên tài giải mã sở hữu tỉ lệ phá án tuyệt đối 100%.", i: "fa-user-secret"}, 
            {n: "THANH TRA Nànána", d: "Nữ thanh tra chính trực, mù tịt công nghệ hiện đại.", i: "fa-user-nurse"},
            {n: "Giáo sư Packy", d: "Nhà phát minh lập dị chuyên cung cấp thiết bị phá án độc bản.", i: "fa-glasses"}, 
            {n: "Wjpu Háo Sắc", d: "Gã nghiện truyện tranh, mê gái hay làm những trò biến thái nhưng rất hữu ích.", i: "fa-face-grin-tears"}, 
            {n: "Sát Thủ 36", d: "Cỗ máy giết người vô cảm, cận vệ của Hacker Lỏ.", i: "fa-robot"}, 
            {n: "Hacker Lỏ", d: "Kẻ giật dây – Bóng ma mã nguồn ẩn danh.", i: "fa-user-ninja"}
        ]   
    },
	/*TRANG 1*/
    { 
        t: "GIAO KÈO TRONG BÓNG TỐI", img: "img/trang1.png", icon: "fa-solid fa-handshake", sound: "",
        flow: [
            { type: "text", content: 
            `<p>
            Rào... rào... Cơn mưa tầm tã trút xuống Ocean-City, nước mưa hắt vào cửa sổ căn gác trọ tồi tàn của Vũ. Vũ — một gã IT thất nghiệp, nghiện cá độ — ngồi chết trân nhìn màn hình máy tính. Trận "all-in" cuối cùng để gỡ gạc nợ nần cho đại ca Long đã tan tành mây khói sau thất bại của MU.</br>
            Tít! Tít! Những dòng tin nhắn đòi nợ từ đại ca Long nhảy lên liên hồi trên điện thoại: "Thằng ranh, sáng mai không thấy tiền thì chuẩn bị quan tài đi!". Vũ run rẩy, mồ hôi lạnh chảy ròng ròng hòa cùng hơi ẩm của cơn mưa. Đúng lúc đó, màn hình máy tính bỗng nhiễu sóng Rè... rè..., một cái mặt nạ kỹ thuật số đầy ma quái hiện lên, che lấp mọi cửa sổ trình duyệt. Đó chính là Hacker Lỏ.
            </p>` },
            { type: "chat", n: "Hacker Lỏ", d: "Chào Vũ, ngươi có muốn xóa sạch nợ nần không?", side: "left" },
            { type: "chat", n: "Vũ", d: "(ngơ ngác, giọng run bắn) Ai vậy? Ngươi là ai? Sao lại đột nhập được vào máy tao?", side: "right" },
            { type: "chat", n: "Hacker Lỏ", d: "Chỉ cần ngươi làm cho ta một việc, ngươi sẽ nhận được số tiền đủ để trả hết nợ và sống hưởng thụ một thời gian dài.", side: "left" },
			{ type: "chat", n: "Vũ", d: "Việc gì? Tao không làm chuyện phạm pháp đâu!", side: "right" },
			{ type: "chat", n: "Hacker Lỏ", d: "Rất đơn giản. Chỉ cần ngươi tung tin đồn Shop Khô Gà của tên Đô làm từ bã mía khô. Khiến tiệm của hắn không thể bán được hàng, chỉ vậy thôi.", side: "left" },
			{ type: "chat", n: "Vũ", d: "Chỉ vậy thôi à? Nhưng làm sao ta có thể tin ngươi?", side: "right" },
			{ type: "chat", n: "Hacker Lỏ", d: "Nhìn vào điện thoại đi", side: "left" },
			{ type: "text", content: `<p>Tinh tinh! Tài khoản ngân hàng báo nhận được 50 triệu đồng. Vũ nhìn con số nhảy lên, đôi mắt hiện lên sự liều lĩnh của kẻ cùng đường.</p>` },
			{ type: "chat", n: "Vũ", d: "(Nghiến răng) Được, chốt kèo!. ", side: "right" },
			{ type: "text", content: `<p>Vũ bắt đầu Cạch... cạch... cạch... gõ phím liên hồi để bắt đầu cuộc chiến trên không gian mạng.</p>` }
        ]
    },
	/*TRANG 2*/
    { 
        t: "CƠN THỊNH NỘ", img: "img/trang2.png", icon: "fa-solid fa-face-angry", sound: "",
        flow: [
			{ type: "text", content: 
            `<p>
			Cạch... cạch... Enter! Vũ nhanh chóng tung ra các bài viết, video ngắn và sử dụng công cụ spam khắp các hội nhóm, khẳng định đanh thép: "Khô gà của tên Đô này làm từ bã mía khô!". Tin đồn lan nhanh như virus, khiến buổi livestream bán hàng của Đô bị đánh sập trong hàng ngàn lời chửi bới của khách hàng.</br>
			Tại văn phòng Shop Khô Gà, Đô — gã chủ shop to cao — rít một hơi thuốc Xasi Khà... nồng hắc. Hắn Rầm! một phát xuống bàn gỗ, quát ba nhân viên của shop với các biệt danh: Nhím, Heo và Rắn.
            </p>` },
            { type: "chat", n: "Đô", d: "(gầm lên) Thằng ranh nào dám tung tin bã mía hại tao? Tra ngay địa chỉ nó cho tao!", side: "left" },
            { type: "chat", n: "Nhím", d: "(run rẩy) Sếp... Lạch cạch... em thấy rồi! Nó không dùng VPN để ẩn danh, địa chỉ ở khu trọ cũ đường X, tên nó là Vũ. Đây là số điện thoại của nó.", side: "right" },
			{ type: "text", content: 
            `<p>
			Đô nhìn vào màn hình, ánh mắt hiện lên sát khí lạnh lùng. Hắn không biết rằng mọi hành động của mình đều đang bị Sát Thủ 36 quan sát qua tiếng Bíp... bíp... từ hệ thống camera đã bị Hacker Lỏ chiếm quyền kiểm soát từ trước.
            </p>` }
        ]
    },
	/*TRANG 3*/
    {
        t: "CUỘC GỌI TỬ THẦN", img: "img/trang3.png", icon: "fa-solid fa-phone", sound: "",
        flow: [
			{ type: "text", content: 
            `<p>
			Chiều hôm đó, Bảo sang nhà Vũ chơi như thường lệ. Cạch! Bảo đẩy cửa vào thì nghe tiếng nước trong phòng tắm Xè... xè... chảy rào rào. Vũ đang hát hò đắc ý vì tin rằng mình sắp đổi đời. Bỗng, điện thoại của Vũ trên bàn Reng... reng... reng... reo dồn dập. Bảo tò mò nhấc máy.
            </p>` },
            { type: "chat", n: "Đô", d: "Alo Vũ phải không Vũ?", side: "left" },
            { type: "chat", n: "Bảo", d: "Không anh ơi. Em là…", side: "right" },
			{ type: "chat", n: "Đô", d: "(giọng gằn xuống) Mày chối làm sao được Vũ. Mày mà không giải quyết vụ này thì tao đăng hết thông tin cá độ của mày lên cho cảnh sát bắt mày đi tù mọt gông!", side: "left" },
			{ type: "text", content: 
            `<p>
			Cụp! Bảo sợ hãi tắt máy ngay lập tức. Khi Vũ bước ra, Bảo kể lại sự việc với giọng run rẩy, nhưng Vũ chỉ cười khẩy:
            </p>` },
			{ type: "chat", n: "Vũ", d: "Kệ nó đi Bảo! Vèo... Tao sắp có tiền tỉ xóa nợ rồi, mấy thằng cho vay dọa suông thôi! Đi ăn đi, hôm nay tao bao!", side: "right" },
			{ type: "text", content: 
            `<p>
			Vũ vẫn ung dung hưởng thụ mà không biết một tai họa khủng khiếp sắp ập xuống đầu mình.
            </p>` }
        ]
    },
	/*TRANG 4*/
    { 
        t: "KHOẢNH KHẮC SINH TỬ", img: "img/trang4.png", icon: "fa-solid fa-skull", sound: "",
        flow: [
			{ type: "text", content: 
            `<p>
			Sáng sớm hôm sau, khi sương mù còn bao phủ Ocean-City, Bảo đang đi mua đồ thì thấy một chiếc xe tải cũ nát đậu trước ngõ. Vũ bị một tên áp giải lên xe đi đâu đó. Bảo âm thầm bám theo nhưng mất dấu giữa những con hẻm ngoằn ngoèo. Bảo kiên trì mò theo dấu vết đến một căn nhà kho cũ ngay khu đường sắt bỏ hoang, xung quanh rau má mọc dại um tùm che kín cả đường ray. Bảo nấp sau tấm tôn rỉ sét kêu Cót két..., nhìn qua khe cửa sắt.</br>
			Trong kho không ánh đèn nên tối mờ mịt, Vũ bị trói chặt quỳ dưới sàn, gương mặt sưng húp vì đã bị đánh cho một trận nhừ tử. Hiện trường lúc này chỉ có Vũ và một tên trùm kín mặt. Hắn đứng khuất sau một bộ PC cũ nát cao 1m45. Từ góc nhìn của Bảo qua khe cửa sắt, kẻ trùm mặt đó có chiều cao đứng bằng với bộ PC.</br>
			"Xoẹt! Phập!" – Kẻ đó bất ngờ ra tay tàn khốc. Một mùi thuốc Xasi nồng nặc lan tỏa ra tận cửa kho. Bảo kinh hoàng, tim đập thình thịch, bỏ chạy thục mạng đến sở cảnh sát báo án. Trên trần nhà kho, Sát Thủ 36 lẳng lặng ghi hình lại toàn bộ cảnh tượng. Tiếng Tách... tách... của tín hiệu truyền trực tiếp về cho Hacker Lỏ.
            </p>` },
			{ type: "chat", n: "Hacker Lỏ", d: "HAHAHA Phải kịch tính như thế này chứ!", side: "left" },			
        ]
    },
	/*TRANG 5*/
    { 
        t: "BỘ PC VÀ XISA", img: "img/trang5.png", icon: "fa-solid fa-computer", sound: "",
        flow: [
			{ type: "text", content: 
            `<p>
			Oén... oén... Tiếng còi xe cảnh sát vang động hiện trường. Thám tử Y Sê Ba và Thanh tra Nànána đã có mặt, đang quan sát thi thể của Vũ bên cạnh bộ PC cao 1m45 trong im lặng. Một ông già tóc tai bù xù, mặc áo blouse trắng — Giáo sư Packy — đang dùng nhíp gắp từng mẩu tàn thuốc nhỏ xíu bên cạnh thi thể.
            </p>` },
            { type: "chat", n: "Giáo sư Packy", d: "Hừm... mùi hương đặc biệt này là thuốc lá Xasi. Loại này cực kỳ đắt đỏ, không phải ai cũng có tiền để hút.", side: "right" },
			{ type: "text", content: 
            `<p>
			Phía sau hàng rào phong tỏa, đám đông người dân hiếu kỳ xì xào. Tên Wjpu Háo Sắc đang lợi dụng đám đông để dở trò biến thái sờ mông một cô gái trẻ. Khi nghe giáo sư nhắc đến thuốc Xasi, hắn nghểnh cổ nói vu vơ:
            </p>` },
			{ type: "chat", n: "Wjpu Háo Sắc", d: "Ối chà, loại thuốc Xasi à? Cái loại đó thì khu này chỉ có những quý nhà giàu có mới hút nhưng lão Đô chủ Shop Khô Gà cũng hay hút loại này mà đám nhân viên của lão cũng hay trộm của lão để hút.", side: "left" },
			{ type: "text", content: 
            `<p>
			Thám tử Y Sê Ba khựng lại, đôi mắt sắc lẹm nhìn về phía đám đông:
            </p>` },
			{ type: "chat", n: "Thám tử Y Sê Ba", d: "Thanh tra Nànána, cô nghe thấy gì không? lời tên Wjpu đó nói. Có vẻ chúng ta cần mời người của Shop Khô Gà về sở cảnh sát để điều tra.", side: "right" }
        ]
    },
	/*TRANG 6*/
    { 
        t: "BUỔI THẨM VẤN CHẾT CHÓC", img: "img/trang6.png", icon: "fa-solid fa-clipboard-question", sound: "",
        flow: [
			{ type: "text", content: 
            `<p>
			Tại sở cảnh sát, bốn người của Shop Khô Gà bị triệu tập thẩm vấn:
            </p>` },
            { type: "chat", n: "Đô", d: "(Chủ shop, cao 1m80, 37 tuổi) thuốc Xasi à? Shop tôi ai chả hút, mà mấy quý ông cấp cao trong thành phố cũng hút. Với lại hung thủ cao bằng bộ PC, ông xem tôi cao to thế này cơ mà!", side: "left" },
			{ type: "chat", n: "Nhím", d: "(Kế toán, cao 1m75, 27 tuổi) Tôi cũng thế, tôi cao thế này mà!", side: "left" },
			{ type: "chat", n: "Rắn", d: "(Nhân viên kho, cao 1m70, 29 tuổi): Tôi cũng vậy, làm sao là tôi được.", side: "left" },
			{ type: "chat", n: "Heo", d: "(Giao hàng, cao đúng 1m45, 27 tuổi) Tôi… tôi.. tôi…", side: "left" },
			{ type: "text", content: 
            `<p>
			Trong lúc phỏng vấn, vì tên Heo có chiều cao đúng 1m45 — trùng khớp hoàn hảo với nhân chứng Bảo nhìn thấy — nên hắn là kẻ run rẩy nhất, mồ hôi đầm đìa. Thấy tên Heo có dấu hiệu tâm lý sắp khai ra sự thật... "Phụt!" – Một mũi kim độc từ lỗ thông gió hạ sát Heo ngay tại chỗ. Hacker Lỏ đã ra lệnh cho Sát Thủ 36 giết Heo để đẩy vụ án lên cao trào. Thanh tra Nànána Rầm! một phát xuống bàn:
            </p>` },
			{ type: "chat", n: "Thanh tra Nànána", d: "Chết tiệt! Heo bị giết để bịt đầu mối! Hắn cao đúng 1m45, bằng bộ PC tại hiện trường, trùng khớp hoàn toàn lời khai của Bảo! Hắn chính là hung thủ, vụ án kết thúc!", side: "right" },
			{ type: "text", content: 
            `<p>
			Đô, Rắn và Nhím cười ngạo nghễ bước ra khỏi sở. Nhưng Thám tử Y Sê Ba vẫn đứng lặng lẽ, tay xoay nhẹ mẩu tàn thuốc với ánh mắt đầy nghi hoặc
            </p>` }
        ]
    },
	/*TRANG 7*/
    { 
        t: "MANH MỐI BẤT NGỜ", img: "img/trang7.png", icon: "fa-solid fa-magnifying-glass", sound: "",
        flow: [
			{ type: "text", content: 
            `<p>
			Thám tử Y Sê Ba quay lại nhà kho cùng Giáo sư Packy. Anh đứng trước bộ PC cao 1m45, nhìn thấy mẫu tàn thuốc trên đỉnh máy. Anh kéo chiếc ghế đẩu cao 50cm đặt ngay sát đó rồi mỉm cười. Thám tử Y Sê Ba móc điện thoại gọi cho Thanh tra Nànána.
            </p>` },
			{ type: "chat", n: "Thám tử Y Sê Ba", d: "Thanh tra Nànána! Chúng ta đã nhầm.", side: "right" },
			{ type: "chat", n: "Thanh tra Nànána", d: "(giọng ngạc nhiên) Ngài nói sao cơ Thám tử? Vậy hung thủ thật sự là ai?", side: "left" },
			{ type: "text", content: 
            `<p>
			Tiếng gió rít qua kẽ lá rào... rào... hòa cùng giọng nói đanh thép của thám tử:
            </p>` },
			{ type: "chat", n: "Thám tử Y Sê Ba", d: "Thung thủ thật sự chính là......", side: "right" },
			{ type: "text", content: 
            `<p>
			Sau khi thám tử Y Sê Ba nói ra tên hung thủ, một giọng nói điện tử bỗng phát ra từ chiếc máy tính cũ nát trong kho:
            </p>` },
			{ type: "chat", n: "Hacker Lỏ", d: "HAHAHA Ngươi giỏi lắm Thám tử Y Sê Ba. Nhưng bữa tiệc vẫn còn dài lắm. CHƯA TÀY ĐÂU HẸ HẸ HẸ!", side: "left" },
        ]
    },
	
	/*TRANG KẾT THÚC*/
    { 
        type: "final", t: "PHÁ ÁN", img: "", icon: "fa-user-check", sound: "KẾT THÚC!",
        flow: [
            { type: "text", content: "<p style='text-align:center; font-weight:800; color:var(--comic-red);'>AI LÀ HUNG THỦ THẬT SỰ?</p>" }
        ]
    }
];

const quizBank = [

/*OT1_LV1*/
	/*Câu 1*/ 
   { type: "single", q: "Bạn muốn lưu danh sách trang web để quay lại sau. Bạn nên dùng tính năng nào của trình duyệt?", 
	opts: ["Duyệt đa trang một lúc", "Lịch sử hoặc Dòng thời gian", "Mục yêu thích hoặc Dấu trang","Hộp địa chỉ"], a: 2, img: "" },
	/*Câu 2*/ 
	{ type: "single", q: "Lịch sử và trang web đánh dấu cho hacker biết nơi bạn truy cập. Nếu mật khẩu được lưu trên thiết bị, hacker có thể dùng gì để đăng nhập vào tài khoản?",
	opts: ["Settings", "Cookies", "History","Cutouts"], a: 1, img: "" },
	/*Câu 3*/ 
	{ type: "single", q: "Lợi ích của việc duyệt Web ở chế độ riêng tư là gì?", 
	opts: ["Không thể nhìn thấy các gói được gửi/nhận qua mạng trường học của bạn.", "Tên của bạn được giữ kín.", "Đăng nhập máy tính và mật khẩu của bạn bị vô hiệu hóa.","Không có lịch sử, cookie, mật khẩu hoặc tệp tạm thời nào được ghi lại trên máy tính."], a: 3, img: "" },
	/*Câu 4*/ 
	{ type: "single", q: "Web riêng tư đảm bảo điều gì sau đây?", 
	opts: ["Lịch sử của người dùng không được lưu trữ", "Mật khẩu không cần thay đổi", "Có nhiều dung lượng lưu trữ hơn trên máy tính","Thông tin tài khoản được lưu"], a: 0, img: "" },
	/*Câu 5*/ 
	{  
        type: "table", 
        q: "Xác định đúng chức năng của các thiết bị sau:", 
        rows: ["Keyboard", "Scanner", "Webcam", "Microphone", "Printer"], 
        labels: ["NHẬP", "XUẤT"],
        a: [true, true, true, true, false] 
    },
	/*Câu 6*/ 
	{ type: "single", q: "Tắt tính năng lưu trữ mật khẩu trực tuyến ở đâu?",
	opts: ["Trong hộp thư đến", "Trong lịch sử của họ", "Trong cài đặt trình duyệt của họ","Trong cài đặt máy tính của họ"], a: 2, img: "" },
	/*Câu 7*/ 
    { type: "multi", q: "Khi nào người dùng nên cân nhắc việc thay đổi mật khẩu của họ? (Chọn 3)", 
	opts: ["Họ đã được thông báo rằng có quyền truy cập trái phép vào tài khoản của họ", "Họ đã cập nhật mật khẩu của họ gần đây", "Họ đã không thay đổi mật khẩu của họ trong một thời gian dài ", "Khi họ muốn đóng tài khoản của mình","Phần mềm độc hại đang chạy trên máy tính của họ"], a: [0, 2, 4] },
	/*Câu 9*/ 
	{ type: "multi", q: "Hành động bạn có thể thực hiện để giúp duy trì quyền riêng tư kỹ thuật số của bản thân? (Chọn 2)", 
	opts: ["Chỉ sử dụng Email trường học của bạn để gửi thông tin cá nhân", "Tắt GPS trên thiết bị của bạn khi không sử dụng thường xuyên", "Định cấu hình cài đặt trình duyệt web của bạn để chặn Cookie", "Lưu trữ tài liệu cá nhân của bạn trên vị trí lưu trữ đám mây"], a: [1, 2] },
	/*Câu 10*/ 
	{ type: "multi", q: "Bạn cần đảm bảo an toàn cho mật khẩu của mình. Đâu là ba nguyên tắc bạn cần tuân thủ? (Chọn 3)", 
	opts: ["Sử dụng mật khẩu dựa trên thông tin riêng tư cá nhân", "Sử dụng mật khẩu khác nhau cho mỗi tài khoản", "Sử dụng mật khẩu phức tạp và ghi vào một cuốn sổ mà bạn luôn mang theo bên mình", "Sử dụng mật khẩu dài nhất hoặc cụm mật khẩu được hệ thống mật khẩu cho phép","Sử dụng các từ có thể tìm thấy trong từ điển của một ngôn ngữ khác với ngôn ngữ chính của bạn","Sử dụng xác thực đa yếu tố, nếu có"], a: [1, 3, 5] },
	/*Câu 11*/
	{ type: "single", q: "Lợi ích của việc duyệt Web ở 'chế độ riêng tư' 'hoặc ẩn danh'?",
	opts: ["Cookie sẽ không báo cáo thông tin về bạn cho bên thứ ba", "Những người khác sẽ không biết được các hoạt động duyệt web của bạn dù sử dụng cùng một thiết bị", "Trình duyệt web của bạn chặn quảng cáo","Không thể sử dụng vân tay kỹ thuật số để theo dõi các hoạt động trên trình duyệt của bạn"], a: 1, img: "" },
	/*Câu 13*/
	{  
        type: "table", 
        q: "Xác định các tính năng tiêu chuẩn của thanh tác vụ trong Hệ điều hành Windows.", 
        rows: ["Khởi động trình quản lý tác vụ", "Điều chỉnh âm lượng đầu ra âm thanh", "Hiển thị cài đặt kết nối mạng", "Thu nhỏ tất cả các chương trình đang mở để hiển thị"], 
        labels: ["CÓ", "KHÔNG"],
        a: [true, true, true, true] 
    },
	/*Câu 14*/
	{ type: "multi", q: "Làm cách nào để người dùng có thể bảo vệ mật khẩu của mình một cách tốt nhất? (Chọn 3)", 
	opts: ["Thay đổi mật khẩu thường xuyên", "Tạo mật khẩu mới cho mọi tài khoản", "Sử dụng cùng một mật khẩu cho tất cả các tài khoản", "Giữ bí mật mật khẩu","Sử dụng số thứ tự trong mật khẩu"], a: [0, 1, 3] },
   /*Câu 16*/
   { type: "multi", q: "Bạn cần tạo một mật khẩu mạnh. Đâu là ba nguyên tắc bạn cần tuân thủ? (Chọn 3)", 
	opts: ["Bao gồm chữ viết hoa và chữ viết thường", "Bao gồm các số dễ nhớ như ngày sinh và số điện thoại", "Bao gồm họ hoặc tên của bạn", "Bao gồm thông tin cá nhân như tên người trong gia đình hoặc tên vật nuôi","Bao gồm các chữ cái, chữ số và ký hiệu","Sử dụng tám ký tự trở lên"], a: [0, 4, 5] },
   /*Câu 17*/
   {  
        type: "table", 
        q: "Xác định các chức năng do Hệ điều hành của máy tính quản lý. Với mỗi tác vụ dưới đây:", 
        rows: ["Chỉnh sửa tập tin văn bản", "Tìm kiếm trên Internet", "Cấp phát tài nguyên phần cứng", "Giao tiếp với các thiết bị ngoại vi"], 
        labels: ["ĐÚNG", "SAI"],
        a: [false, false, true, true] 
    },
	/*Câu 18*/
   { 
        type: "matching", 
        q: "Xác định mục đích của các công cụ trình duyệt Web phổ biến. ", 
        left: ["Hiển thị lại một trang web đã 'truy cập trước đó'", "Tải lại trang web hiện tại", "Liệt kê các trang web bạn đã truy cập gần đây","Hiển thị URL của trang web hiện tại"], 
        right: ["Address box", "Refresh button", "History","Back button"], 
        a: { 0:3, 1:1, 2:2, 3:0} 
    },
	/*Câu 20*/
	{ type: "single", q: "Máy tính để bàn sử dụng phần cứng nào để lưu trữ dữ liệu lâu dài?",
	opts: ["Bộ xử lý trung tâm (CPU)", "Ổ đĩa Flash USB", "Bo mạch chủ","Ổ đĩa cứng"], a: 3, img: "" },
	/*Câu 21*/
	{ type: "multi", q: "Thiết bị phải có khả năng chạy bằng pin và phải được trang bị bàn phím vật lý tích hợp. Đâu là hai thiết bị đáp ứng được những yêu cầu trên? (Chọn 2)", 
	opts: ["Máy tính xách tay chạy Windows", "Máy tính để bàn Mac", "Máy tính đa năng chạy Windows", "Điện thoại thông minh chạy Android","Máy tính bảng chạy Android","Chromebook"], a: [0, 5] },
	/*Câu 23*/
	{ type: "multi", q: "Điều nào đúng với Hệ điều hành Linux? (Chọn 3)", 
	opts: ["Độc quyền", "Không thể được sử dụng trên bất cứ thứ gì ngoại trừ các thiết bị di động", "Có thể chạy trên mọi phần cứng", "Người dùng có thể sửa đổi phần mềm thông qua mã nguồn của chương trình","Có tính bảo mật cao"], a: [2, 3, 4] },
	/*Câu 24*/
   {  
        type: "table", 
        q: "Với mỗi loại phần mềm, hãy xác định xem đó là 'Phần mềm Hệ Thống' hay 'Phần mềm Ứng Dụng'.", 
        rows: ["Trình duyệt Web", "Bộ phát đa phương tiện", "Trình điều khiển card đồ họa", "Trình quản lý phân vùng ổ đĩa"], 
        labels: ["ỨNG DỤNG", "HỆ THỐNG"],
        a: [true, true, false, false] 
    },
	/*Câu 25*/
   {  
        type: "table", 
        q: "Sự khác biệt giữa mạng có dây và không dây, hãy chọn Đúng hoặc Sai.", 
        rows: ["Kết nối Wi-Fi được mã hóa an toàn hơn so với kết nối Ethernet", "Kết nối Wi-Fi thường ít xảy ra độ trễ khi truyền dữ liệu hơn so với kết nối Ethernet", "Kết nối Ethernet thường cung cấp tốc độ kết nối mạng nhanh hơn kết nối Wi-Fi"], 
        labels: ["ĐÚNG", "SAI"],
        a: [false, false, true] 
    },
	/*Câu 26*/
	{ type: "single", q: "Thiết bị nào chuyển đổi dữ liệu từ kỹ thuật số (Digital) sang tương tự (Analog) và ngược lại để truyền tín hiệu qua mạng?",
	opts: ["Router", "Ethernet Cable", "Network Adapter","Modem"], a: 3, img: "" },
	/*Câu 27*/
	{ type: "single", q: "Loại cáp nào có thể truyền dữ liệu lên đến 480 megabit/giây?",
	opts: ["USB", "USB-C", "Micro USB","Lightning connecter"], a: 3, img: "" },
	/*Câu 28*/
   {  
        type: "table", 
        q: "Với mỗi câu phát biểu về những lợi ích của cơ sở hạ tầng mạng chất lượng, hãy chọn Đúng hoặc Sai.", 
        rows: ["Đảm bảo rằng học sinh có thể kết nối thông suốt với mạng của nhà trường", "Cho phép học sinh kết nối với phòng máy tính của nhà trường từ mọi nơi", "Hỗ trợ mở rộng hệ thống mạng của nhà trường mà không cần thiết kế lại khi số lượng học sinh tăng lên"], 
        labels: ["ĐÚNG", "SAI"],
        a: [true, false, true] 
    },
	/*Câu 29*/
	{ type: "multi", q: "Ba phát biểu nào dưới đây đúng với phần mềm nguồn mở? (Chọn 3)",  
	opts: ["Nó an toàn hơn phần mềm độc quyền", "Nó kém an toàn hơn phần mềm độc quyền", "Giấy phép của nó là trung lập về công nghệ", "Nó cho phép người dùng sửa đổi phần mềm để phù hợp với nhu cầu cụ thể của họ","Nó thân thiện với người dùng hơn phần mềm độc quyền"], a: [0, 2, 3] },
	/*Câu 30*/
   {  
        type: "table", 
        q: "Sự khác biệt giữa 'Internet' và 'mạng nội bộ'", 
        rows: ["Internet thuộc quyền sở hữu riêng của các tổ hợp công ty liên doanh", "Kết nối nội bộ an toàn hơn so với kết nối Internet ", "Mạng nội bộ không giới hạn số lượng người dùng và bất kỳ ai cũng có thể truy cập được"], 
        labels: ["ĐÚNG", "SAI"],
        a: [false, true, false] 
    },
	/*Câu 31*/
	{ type: "multi", q: "Ba phát biểu nào dưới đây đúng với phần mềm độc quyền? (Chọn 3)",  
	opts: ["Nó kém an toàn hơn phần mềm nguồn mở", "Nó dễ bị phần mềm độc hại tấn công hơn phần mềm nguồn mở", "Giấy phép của nó là trung lập về công nghệ", "Nó cho phép người dùng sửa đổi phần mềm để phù hợp với nhu cầu cụ thể của họ","Nó thân thiện với người dùng hơn phần mềm nguồn mở"], a: [0, 1, 4] },
	/*Câu 32*/
	{ type: "single", q: "Đâu là câu phát biểu đúng về các ứng dụng dựa trên môi trường Web?",
	opts: ["Bạn phải có kết nối Internet để sử dụng ứng dụng Web", "Phiên bản Web của ứng dụng dành cho máy tính để bàn sở hữu tất cả các tính năng giống như phiên bản trên máy tính để bàn", "Các ứng dụng Web xử lý cục bộ thông tin trên máy tính của bạn","Trước khi có thể sử dụng ứng dụng Web, bạn phải cài đặt ứng dụng đó trên máy tính của mình"], a: 0, img: "" },
	/*Câu 33*/
   {  
        type: "table", 
        q: "Với mỗi câu phát biểu về phần mềm mã nguồn mở, hãy chọn Đúng hoặc Sai:", 
        rows: ["Tất cả phần mềm miễn phí đều là phần mềm mã nguồn mở", "Bất kỳ ai cũng có thể kiểm tra, sửa đổi và cải tiến mã nguồn của phần mềm mã nguồn mở", "Bạn phải đồng ý với Thỏa thuận cấp phép Người dùng cuối trước khi sử dụng phần mềm mã nguồn mở"], 
        labels: ["ĐÚNG", "SAI"],
        a: [false, true, false] 
    },
	/*Câu 34*/
   { 
        type: "matching", 
        q: "Ghép từng loại ứng dụng phần mềm với mục đích tương ứng:", 
        left: ["Hệ thống quản lý cơ sở dữ liệu", "Phần mềm xử lý văn bản", "Phần mềm trình chiếu","Trình duyệt web","Ứng dụng bảng tính"], 
        right: ["Sắp xếp, phân tích cũng như lưu trữ dữ liệu số và văn bản, tính toán và hiển thị dữ liệu dưới dạng biểu đồ", "Hiển thị văn bản, hình ảnh và thông tin đa phương tiện dưới dạng trình chiếu điện tử", "Truy cập thông tin trên internet","Lưu trữ, sắp xếp, điều khiển và điều chỉnh các tập hợp thông tin liên quan","Nhập, chỉnh sửa, định dạng và xuất văn bản ở định dạng tài liệu"], 
        a: { 0:3, 1:4, 2:1, 3:2, 4:0} 
    },
	/*Câu 35*/
	{ type: "single", q: "Loại USB nào có đầu nối có thể đảo ngược khi sử dụng?",
	opts: ["Micro USB", "USB-C", "USB","Lightning connecter"], a: 1, img: "" },
	/*Câu 36*/
	{ type: "single", q: "Làm cách nào bạn có thể xác định xem thiết bị của mình có được kết nối với Internet hay không?",
	opts: ["Hãy thử gửi một tin nhắn", "Mở trình duyệt", "Tải xuống ứng dụng Speedtest","Thử lưu một tập tin"], a: 1, img: "" },
	/*Câu 37*/
   { 
        type: "matching", 
        q: "Ghép từng thiết bị lưu trữ dữ liệu với định nghĩa tương ứng:", 
        left: ["Ổ cứng thể rắn", "Ổ đĩa flash USB", "Ổ cứng di động","Ổ đĩa cứng"], 
        right: ["Thiết bị lưu trữ dữ liệu bên ngoài gọn nhẹ, sử dụng bộ nhớ flash", "Thiết bị lưu trữ dữ liệu bên trong giúp lưu trữ và truy xuất dữ liệu bằng bộ nhớ flash", "Thiết bị lưu trữ dữ liệu cơ điện tử bên trong giúp lưu trữ và truy xuất dữ liệu bằng đĩa từ quay nhanh","Thiết bị lưu trữ dữ liệu bên ngoài hoạt động dựa trên kết nối USB với máy tính"], 
        a: { 0:1, 1:0, 2:3, 3:2} 
    },
	/*Câu 38*/
   {  
        type: "table", 
        q: "Bạn cần xác định PII không nên tiết lộ online. Với mỗi phát biểu, chọn Có nếu là PII hoặc Không nếu không.", 
        rows: ["Màu mắt", "Ngày sinh", "Nơi sinh"], 
        labels: ["CÓ", "KHÔNG"],
        a: [false, true, true] 
    },
	/*Câu 39*/
   {  
        type: "table", 
        q: "Với mỗi câu phát biểu, hãy chọn Đúng nếu đó là ví dụ về bắt nạt trên mạng hoặc Sai nếu không phải", 
        rows: ["A Liên tục gửi những tin nhắn ác ý riêng cho B", "C Đăng tải một ý kiến gây tranh cãi trên một diễn đàn trực tuyến công khai", "D Đăng ảnh riêng tư của E lên mạng mà không có sự cho phép của cô","F tạo một tài khoản Instagram để đăng tải những tin đồn về các học sinh trong trường"], 
        labels: ["ĐÚNG", "SAI"],
        a: [true, false, true, false] 
    },
	/*Câu 40*/
	{ type: "single", q: "Cách an toàn để gửi thông tin nhận dạng cá nhân (PII - Personally Identifiable Information) qua Email là gì?",
	opts: ["Bằng cách chỉ gửi Email PII cho người thân", "Bằng cách mã hóa Email", "Không bao giờ gửi Email","Bằng cách giải mã một Email"], a: 1, img: "" },
	/*Câu 41*/
   {  
        type: "table", 
        q: "Với mỗi câu phát biểu, hãy chọn Đúng hoặc Sai.", 
        rows: ["Bạn sẽ bị quy vào tội đạo văn nếu không trích dẫn nguồn đầy đủ", "Trong tác phẩm viết, bạn phải sử dụng phần chú thích cuối trang để trích dẫn nguồn", "Bạn có thể mạo nhận tác phẩm hoặc ý tưởng của người khác làm của riêng mình mà không cần trích dẫn nguồn","Bạn chỉ phải trích dẫn nguồn khi sử dụng câu văn chính xác như trong tác phẩm gốc của người khác"], 
        labels: ["ĐÚNG", "SAI"],
        a: [true, true, false, false] 
    },
	/*Câu 42*/
	{ type: "multi", q: "Bốn điều nào được coi là thông tin nhận dạng cá nhân PII-Personally Indentifiable Information?(Chọn 4)", 
	opts: ["Số an sinh xã hội", "Địa chỉ gửi thư", "Kích thước quần áo", "Màu tóc","Lịch sử quét sinh trắc học","Địa chỉ IP"], a: [0,1, 4, 5] },
	/*Câu 43*/
   {  
        type: "table", 
        q: "Bạn cần xác định ví dụ về hành xử đúng mực trên mạng trong môi trường văn phòng. Với mỗi phát biểu, chọn Có nếu đúng hoặc Không nếu không.", 
        rows: ["Luôn Cc cho đồng nghiệp khi gửi email để giúp họ nắm được thông tin","Chia sẻ các tập tin lớn từ dịch vụ lưu trữ đám mây hoặc vị trí máy chủ thay vì đính kèm trong email","Áp dụng các tiêu chuẩn và giá trị trong các tương tác trực tuyến tương tự như khi bạn tương tác trực tiếp"], 
        labels: ["CÓ", "KHÔNG"],
        a: [false, true, true] 
    },
	/*Câu 44*/
   {  
        type: "table", 
        q: "Với mỗi câu phát biểu về các phương pháp trích dẫn, hãy chọn Đúng hoặc Sai.", 
        rows: ["Bạn phải trích dẫn nguồn nếu trích dẫn trực tiếp từ một bài phát biểu","Bạn phải trích dẫn nguồn nếu diễn đạt lại bài viết của một người khác ","Bạn phải trích dẫn nguồn nếu tóm tắt bài viết của một người khác","Bạn nên đặt dấu ngoặc kép xung quanh các cụm từ gồm ba từ trở lên được trích dẫn từ bài viết của một người khác"], 
        labels: ["CÓ", "KHÔNG"],
        a: [true, true, true, true] 
    },
	/*Câu 45*/
	{ type: "multi", q: "Đâu là ba yếu tố phải có trong trích dẫn về một cuốn sách đã xuất bản? (Chọn 3)", 
	opts: ["Tên tác giả", "Tên sách", "Ngày xuất bản", "Ngày truy cập","Tình trạng bản quyền","Tình trạng thương hiệu"], a: [0,1, 2] }
];

/* --- KHỞI TẠO BIẾN VÀ HỆ THỐNG CÂU HỎI KHÔNG LẶP --- */
let curPage = 0, maxOpenedPage = 0, streak = 0, tempSelections = [], currentQ = null, matchPairs = {};
// Tạo danh sách câu hỏi chưa trả lời dựa trên kho quizBank gốc
let availableQuestions = [...quizBank]; 

function init() { render(); }

function render() {
    const p = story[curPage];
    const container = document.getElementById('content-render');
    document.getElementById('btn-prev').disabled = (curPage === 0);
    document.getElementById('btn-next').disabled = (curPage === story.length - 1);
    container.classList.remove('page-transition');
    void container.offsetWidth; 
    container.classList.add('page-transition');
    
    let label = (p.type === 'intro') ? 'HỒ SƠ' : ((p.type === 'final') ? 'KẾT THÚC' : 'TRANG ' + curPage);
    let h = `<div class="comic-panel"><span class="chapter-badge">${label}</span><h2 style="text-align:center;font-family:'Montserrat';border-bottom:4px solid #000;margin-top:10px;">${p.t}</h2>`;
    
    if(p.type !== "intro" && p.type !== "final") {
        h += `<div style="width:100%; min-height:150px; background:#222; border:4px solid #000; display:flex; align-items:center; justify-content:center; position:relative; margin-bottom:15px; overflow:hidden;">`;
        if (p.img && p.img !== "") h += `<img src="${p.img}" style="width:100%; height:auto; display:block;">`;
        else h += `<i class="fas ${p.icon} fa-4x" style="color:var(--comic-yellow)"></i>`;
        h += `<div style="position:absolute; bottom:5px; right:15px; font-family:'Montserrat'; font-size:2em; color:var(--comic-yellow); -webkit-text-stroke:1px #000; z-index:5;">${p.sound}</div></div>`;
    }

    p.flow.forEach(item => {
        if(item.type === "text") h += `<div class="story-text-block">${item.content}</div>`;
        else if(item.type === "chat") {
            const sideClass = item.side === 'left' ? 'chat-left' : 'chat-right';
            h += `<div class="${sideClass}" style="display:flex; flex-direction:column; margin-bottom:10px;"><div class="char-label-container"><span class="char-full-name">${item.n}</span></div><div class="bubble">${item.d}</div></div>`;
        }
    });

    if(p.type === "intro") {
        h += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">`;
        p.chars.forEach(c=>h+=`<div style="border:3px solid #000;padding:12px;text-align:center;background:#fff;box-shadow:4px 4px 0 #000;"><i class="fas ${c.i} fa-2x" style="margin-bottom:8px;"></i><div style="font-weight:900;text-transform:uppercase;font-size:0.9em;">${c.n}</div><div style="font-size:0.8em;margin-top:5px;font-weight:400;">${c.d}</div></div>`);
        h += `</div>`;
    } else if(p.type === "final") {
        h += `<div id="culprit-selection" style="margin:20px 0;">
                <div class="opt-item" onclick="finalCheck(this, 'nhim')">Nhím</div>
                <div class="opt-item" onclick="finalCheck(this, 'ran')">Rắn</div>
                <div class="opt-item" onclick="finalCheck(this, 'do')">Đô</div>
                <div class="opt-item" onclick="finalCheck(this, 'satthu36')">Sát Thủ 36</div>
              </div>`;
    }
    container.innerHTML = h + `</div>`;
    renderDots();
}

function allowDrop(ev) { ev.preventDefault(); }
function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }

function drop(ev) {
    ev.preventDefault();
    const rightId = ev.dataTransfer.getData("text");
    const leftId = ev.target.id;
    if(leftId.startsWith("L-") && rightId.startsWith("R-") && !ev.target.classList.contains('matched')) {
        const rIdx = rightId.split("-")[1];
        const lIdx = leftId.split("-")[1];
        matchPairs[lIdx] = parseInt(rIdx);
        document.getElementById(rightId).style.visibility = "hidden";
        ev.target.classList.add('matched');
        ev.target.setAttribute('data-right-id', rightId);
        ev.target.innerText = currentQ.left[lIdx] + " ➔ " + currentQ.right[rIdx];
        ev.target.onclick = function() { resetMatch(this); };
    }
}

function resetMatch(el) {
    const rightId = el.getAttribute('data-right-id');
    const lIdx = el.id.split("-")[1];
    delete matchPairs[lIdx];
    document.getElementById(rightId).style.visibility = "visible";
    el.classList.remove('matched');
    el.innerText = currentQ.left[lIdx];
    el.onclick = null;
    el.removeAttribute('data-right-id');
}

/* --- HÀM RANDOM CÂU HỎI KHÔNG LẶP LẠI --- */
function startRandomQuiz() {
    // Nếu hết câu hỏi để quay vòng thì nạp lại từ đầu
    if (availableQuestions.length === 0) {
        availableQuestions = [...quizBank];
    }

    const randomIndex = Math.floor(Math.random() * availableQuestions.length);
    currentQ = availableQuestions[randomIndex];
    currentQ._tempIndex = randomIndex; // Lưu vị trí để xóa nếu làm đúng

    tempSelections = []; matchPairs = {};
    document.getElementById('q-desc').innerText = currentQ.q;
    document.getElementById('q-msg').innerText = "";
    document.getElementById('quiz-modal').classList.add('active');
    
    const container = document.getElementById('q-container');
    const instr = document.getElementById('q-instr');
    container.innerHTML = "";
    instr.innerText = "Trả lời câu hỏi để qua trang tiếp theo";

    if(currentQ.type === "single" || currentQ.type === "multi") {
        currentQ.opts.forEach((o, i) => {
            container.innerHTML += `<div class="opt-item" id="opt-${i}" onclick="${currentQ.type==='single'?'selectSingle':'selectMulti'}(${i})">${o}</div>`;
        });
    } 
    else if(currentQ.type === "table") {
        // Tùy chỉnh tiêu đề cột linh hoạt
        let headers = (currentQ.labels && currentQ.labels.length === 2) ? currentQ.labels : ["Đúng", "Sai"]; 
        let t = `<table class="quiz-table">
                    <tr>
                        <th style="text-align:left"></th>
                        <th>${headers[0]}</th> 
                        <th>${headers[1]}</th>
                    </tr>`;
        currentQ.rows.forEach((r, i) => {
            t += `<tr>
                    <td style="text-align:left">${r}</td>
                    <td><input type="radio" name="r-${i}" value="true"></td>
                    <td><input type="radio" name="r-${i}" value="false"></td>
                  </tr>`;
        });
        container.innerHTML += t + `</table>`;
    } 
    else if(currentQ.type === "matching") {
        instr.innerText = "KÉO Ô VÀNG (PHẢI) THẢ VÀO Ô XÁM (TRÁI). CLICK Ô TRÁI ĐỂ GỠ.";
        let m = `<div class="matching-container"><div class="match-col">`;
        currentQ.left.forEach((text, i) => m += `<div class="match-item match-left-item" ondrop="drop(event)" ondragover="allowDrop(event)" id="L-${i}">${text}</div>`);
        m += `</div><div class="match-col">`;
        currentQ.right.forEach((text, i) => m += `<div class="match-item match-right-item" draggable="true" ondragstart="drag(event)" id="R-${i}">${text}</div>`);
        m += `</div></div>`;
        container.innerHTML += m;
    }
    updateStreakBar();
}

/* --- HÀM KIỂM TRA ĐÁP ÁN VÀ LOẠI BỎ CÂU ĐÚNG --- */
function checkQuiz() {
    let ok = false;
    if(currentQ.type === "single") {
        ok = tempSelections[0] === currentQ.a;
    } 
    else if(currentQ.type === "multi") {
        ok = tempSelections.length === currentQ.a.length && currentQ.a.every(v => tempSelections.includes(v));
    } 
    else if(currentQ.type === "table") {
        let ans = currentQ.rows.map((_, i) => {
            let s = document.querySelector(`input[name="r-${i}"]:checked`);
            return s ? (s.value === "true") : null; 
        });
        if (ans.includes(null)) {
            document.getElementById('q-msg').innerText = "Vui lòng trả lời đầy đủ các dòng!";
            return;
        }
        ok = ans.every((val, i) => val === currentQ.a[i]);
    } 
    else if(currentQ.type === "matching") {
        let leftKeys = Object.keys(currentQ.a);
        ok = Object.keys(matchPairs).length === leftKeys.length && leftKeys.every(key => matchPairs[key] === currentQ.a[key]);
    }

    if(ok) {
        // Nếu đúng: Xóa câu này khỏi danh sách chờ để không lặp lại
        availableQuestions.splice(currentQ._tempIndex, 1);
        
        streak++; 
        updateStreakBar();
        if(streak >= CONFIG.requiredStreak) { 
            curPage++; 
            maxOpenedPage = curPage; 
            closeQuiz(); 
            render(); 
        } else {
            startRandomQuiz();
        }
    } else {
        // Nếu sai: Giữ nguyên để người dùng có thể gặp lại sau
        streak = 0; 
        updateStreakBar();
        document.getElementById('quiz-box').classList.add('shake-screen');
        setTimeout(() => document.getElementById('quiz-box').classList.remove('shake-screen'), 400);
        document.getElementById('q-msg').innerText = "Sai rồi! Thử lại nhé.";
        setTimeout(() => startRandomQuiz(), 1000);
    }
}

function selectSingle(i) { tempSelections = [i]; document.querySelectorAll('.opt-item').forEach((el, idx) => el.classList.toggle('selected', idx === i)); }
function selectMulti(i) { const idx = tempSelections.indexOf(i); if(idx > -1) tempSelections.splice(idx, 1); else tempSelections.push(i); document.getElementById(`opt-${i}`).classList.toggle('selected'); }

function finalCheck(element, choice) {
    const overlay = document.getElementById('final-overlay');
    const content = document.getElementById('result-content');
    overlay.style.display = "flex";
    if(choice === 'do') {
        element.classList.add('correct');
        document.body.style.background = "#2e7d32";
        content.innerHTML = `
            <h2 style="font-family:'Montserrat';color:#2e7d32;">PHÁ ÁN THÀNH CÔNG!</h2>
            <div style="text-align:left; border:4px solid #000; padding:15px; background:#f9f9f9; margin-top:15px; font-weight:400;">
                <div style="background:var(--comic-yellow); padding:10px; border:2px solid #000; margin-bottom:15px;">
                    <strong style="color:red">KẾT LUẬN CỦA THÁM TỬ Y SÊ BA:</strong><br>
                    Dưới bóng tối mờ ảo trong kho và chiếc bàn có khăn trải bàn, Bảo nhìn nhầm chiều cao vì hung thủ ngồi trên chiếc ghế đẩu 50cm. Dựa vào tỉ lệ nhân trắc học:</br>
                    Cao độ ngồi = 50cm + (Chiều cao x 52.8%)</br>
                    •   Rắn (1m70): Ngồi cao 139.7cm (Thấp hơn PC 5cm).</br>
                    •   Nhím (1m75): Ngồi cao 142.4cm (Thấp hơn PC 2.5cm).</br>
                    •   Đô (1m80): Ngồi cao đúng 145cm — Khớp hoàn hảo với đỉnh bộ PC.</br>
                    Chính độ cao trùng khớp này đã tạo ra ảo giác về một "hung thủ thấp bé", nhưng thực tế là do Đô đang ngồi trên chiếc ghế.
                </div>
                <div style="background:#e3f2fd; padding:10px; border:2px solid #000;">
                    <strong style="color:var(--comic-blue)">HÀNH VI CỦA HACKER LỎ:</strong><br>
                    Trả thù cho người yêu tử vong do mắc nghẹn khi ăn khô gà. Vì căm ghét những kẻ kinh doanh món ăn này, hắn lợi dụng khoản nợ của Vũ để ép anh phá hoại shop của Đô, để dẫn dụ Đô phạm tội, nhằm xóa sổ những kẻ kinh doanh khô gà.
                </div>
            </div>
            <button class="comic-btn" style="width:100%; margin-top:15px;" onclick="closeResult()">ĐÓNG HỒ SƠ</button>`;
    } else {
        element.classList.add('wrong');
        document.getElementById('game-container').classList.add('shake-screen');
        document.body.style.background = "#b71c1c";
        content.innerHTML = `<h2 style="font-family:'Montserrat';color:var(--comic-red)">BẮT NHẦM NGƯỜI!</h2><button class="comic-btn" onclick="closeResult()">THỬ LẠI</button>`;
        setTimeout(() => document.getElementById('game-container').classList.remove('shake-screen'), 500);
    }
}

function updateStreakBar() { document.getElementById('streak-bar').style.width = (streak / CONFIG.requiredStreak * 100) + "%"; document.getElementById('streak-val').innerText = `${streak}/${CONFIG.requiredStreak}`; }
function closeQuiz() { document.getElementById('quiz-modal').classList.remove('active'); }
function closeResult() { document.getElementById('final-overlay').style.display = "none"; document.body.style.background = "#1a1a1a"; }
function handleNext() { if (curPage === 0 || curPage < maxOpenedPage) { curPage++; render(); } else if (curPage < story.length - 1) { streak = 0; startRandomQuiz(); } }
function renderDots() { let h = ""; story.forEach((_, i) => h += `<div style="width:10px; height:10px; border:2px solid #000; border-radius:50%; background:${i <= curPage ? 'var(--comic-red)' : '#ccc'}"></div>`); document.getElementById('nav-dots').innerHTML = h; }
function prev() { if (curPage > 0) { curPage--; render(); } }
window.onload = init;
</script>
</body>
</html>